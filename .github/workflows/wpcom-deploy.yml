name: WordPress.com Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare deployment files
        run: |
          mkdir -p wpcom-deploy
          # Copy only the files we want to deploy to /wp-content/
          cp -r themes wpcom-deploy/themes
          cp -r plugins wpcom-deploy/plugins
          cp -r mu-plugins wpcom-deploy/mu-plugins
          cp -r jetpack-waf wpcom-deploy/jetpack-waf
          # Copy index.php if it exists at root
          if [ -f index.php ]; then
            cp index.php wpcom-deploy/index.php
          fi
          # Exclude .git directories
          find wpcom-deploy -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wpcom
          path: wpcom-deploy
          retention-days: 1
